<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>IMPACTA | Manager Command</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{ --brand:#0c62ab; --brand-dark:#094a80; --ink:#0f172a; --muted:#64748b; --line:#e2e8f0; --bg:#f1f5f9; --radius:12px; --sans: system-ui, -apple-system, sans-serif; }
    *{box-sizing:border-box} body{ margin:0; font-family:var(--sans); background:var(--bg); color:var(--ink); }
    .app { display:grid; grid-template-columns: 240px 1fr; min-height:100vh; }
    .sidebar { background:var(--brand-dark); color:white; padding:20px; display:flex; flex-direction:column; gap:8px; }
    .nav-item { padding:12px; border-radius:8px; cursor:pointer; opacity:0.8; transition:0.2s; text-align:left; background:none; border:none; color:white; width:100%; font-size:14px; font-weight:600; }
    .nav-item:hover, .nav-item.active { background:rgba(255,255,255,0.15); opacity:1; }
    .main { padding:30px; overflow-y:auto; }
    .card { background:white; border-radius:var(--radius); border:1px solid var(--line); padding:24px; margin-bottom:24px; box-shadow:0 4px 6px -1px rgba(0,0,0,0.05); }
    h1 { margin:0 0 20px; font-size:24px; color:var(--brand); }
    table { width:100%; border-collapse:collapse; font-size:14px; }
    th { text-align:left; padding:12px; border-bottom:2px solid var(--line); color:var(--muted); font-size:12px; text-transform:uppercase; }
    td { padding:12px; border-bottom:1px solid var(--line); }
    input, select { padding:8px; border:1px solid var(--line); border-radius:6px; width:100%; }
    .btn { padding:8px 16px; background:var(--brand); color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600; }
    .btn.danger { background:#ef4444; }
    .view { display:none; } .view.active { display:block; }
    .kpi-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:20px; }
    .kpi-box { background:white; padding:20px; border-radius:var(--radius); border:1px solid var(--line); }
    .kpi-val { font-size:28px; font-weight:800; color:var(--brand); }
    .kpi-lbl { font-size:12px; color:var(--muted); text-transform:uppercase; font-weight:bold; }
  </style>
</head>
<body>
  <div class="app">
    <div class="sidebar">
      <h2 style="font-size:14px; text-transform:uppercase; letter-spacing:1px; opacity:0.7; margin-bottom:20px;">Manager OS</h2>
      <button class="nav-item active" onclick="switchTab('leads')">Lead Assignment</button>
      <button class="nav-item" onclick="switchTab('users')">User Manager</button>
      <button class="nav-item" onclick="switchTab('reports')">Reports</button>
      <div style="flex:1"></div>
      <button class="nav-item" onclick="logout()">Logout</button>
    </div>

    <div class="main">
      <div id="leads" class="view active">
        <h1>Lead Assignment</h1>
        <div class="card">
          <div style="display:flex; gap:10px; margin-bottom:20px; align-items:center;">
            <select id="assignUserSel" style="max-width:200px;"></select>
            <button class="btn" onclick="assignLeads()">Assign Selected</button>
            <button class="btn" onclick="fetchData()">Refresh</button>
          </div>
          <table id="assignTable">
            <thead><tr><th width="30"><input type="checkbox" onclick="toggleAll(this)"></th><th>Company / Lead</th><th>Status</th><th>Current Owner</th></tr></thead>
            <tbody id="assignBody"></tbody>
          </table>
        </div>
      </div>

      <div id="users" class="view">
        <h1>User Manager</h1>
        <div class="card" style="display:grid; grid-template-columns:1fr 1fr 1fr auto; gap:10px; align-items:end; background:#f8fafc;">
          <div><label style="font-size:12px;">Name</label><input id="new_name"></div>
          <div><label style="font-size:12px;">Email</label><input id="new_email"></div>
          <div><label style="font-size:12px;">Password</label><input id="new_pass"></div>
          <button class="btn" onclick="addUser()">Add Rep</button>
        </div>
        <div class="card">
          <table>
            <thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Action</th></tr></thead>
            <tbody id="userTable"></tbody>
          </table>
        </div>
      </div>

      <div id="reports" class="view">
        <h1>Pipeline Health</h1>
        <div class="kpi-grid" id="reportKpis" style="margin-bottom:20px;"></div>
        <div class="card">
          <h3>Activity by Rep</h3>
          <table id="repStatsTable">
            <thead><tr><th>Rep Name</th><th>Total Leads</th><th>Deals Closed</th></tr></thead>
            <tbody id="repStatsBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- CONFIGURATION ---
    const SUPABASE_URL = 'imszwgxngjuanjvxigel';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imltc3p3Z3huZ2p1YW5qdnhpZ2VsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5OTI5NDUsImV4cCI6MjA4NTU2ODk0NX0.hag2-X1LVKmQe11QfBt9IYxQC7A9_uranVKgRBJaH4Q';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // State
    let leads = [];
    let users = [];
    const currentUser = JSON.parse(localStorage.getItem("impacta_user"));

    if(!currentUser || currentUser.role !== 'manager') window.location.href = 'lite9876932.html';

    async function fetchData() {
      const { data: uData } = await supabase.from('users').select('*');
      const { data: lData } = await supabase.from('leads').select('*').order('created_at', { ascending: false });
      
      users = uData || [];
      leads = lData || [];
      
      renderLeadAssign();
      renderUsers();
      renderReports();
    }

    function switchTab(id) {
      document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    function renderLeadAssign() {
      const userSel = document.getElementById("assignUserSel");
      userSel.innerHTML = '<option value="">-- Select Rep --</option>' + users.map(u => `<option value="${u.id}">${u.name}</option>`).join('');
      
      document.getElementById("assignBody").innerHTML = leads.map(l => {
        const owner = users.find(u => u.id === l.assigned_to)?.name || '<span style="color:#ef4444">Unassigned</span>';
        return `<tr>
          <td><input type="checkbox" class="lead-check" value="${l.id}"></td>
          <td><b>${l.company || 'Unknown'}</b><br><span style="font-size:12px;color:#64748b">${l.first_name||''} ${l.last_name||''}</span></td>
          <td>${l.stage}</td>
          <td>${owner}</td>
        </tr>`;
      }).join('');
    }

    function toggleAll(source) {
      document.querySelectorAll('.lead-check').forEach(c => c.checked = source.checked);
    }

    async function assignLeads() {
      const userId = document.getElementById("assignUserSel").value;
      if(!userId) return alert("Select a user.");
      const checked = Array.from(document.querySelectorAll('.lead-check:checked')).map(c => c.value);
      
      if(checked.length > 0) {
        await supabase.from('leads').update({ assigned_to: userId }).in('id', checked);
        fetchData();
        alert("Assigned.");
      }
    }

    async function addUser() {
      const name = document.getElementById("new_name").value;
      const email = document.getElementById("new_email").value;
      const pass = document.getElementById("new_pass").value;
      
      const { error } = await supabase.from('users').insert([{ name, email, password: pass, role: 'rep' }]);
      if(error) alert("Error adding user");
      else {
        document.getElementById("new_name").value = "";
        fetchData();
      }
    }

    async function removeUser(id) {
      if(confirm("Remove user?")) {
        await supabase.from('users').delete().eq('id', id);
        fetchData();
      }
    }

    function renderUsers() {
      document.getElementById("userTable").innerHTML = users.map(u => `<tr>
        <td>${u.name}</td><td>${u.email}</td><td>${u.role}</td>
        <td><button class="btn danger" onclick="removeUser('${u.id}')">Remove</button></td>
      </tr>`).join('');
    }

    function renderReports() {
      const sold = leads.filter(l => l.stage && l.stage.includes('Sold')).length;
      document.getElementById("reportKpis").innerHTML = `
        <div class="kpi-box"><div class="kpi-lbl">Total Leads</div><div class="kpi-val">${leads.length}</div></div>
        <div class="kpi-box"><div class="kpi-lbl">Deals Closed</div><div class="kpi-val">${sold}</div></div>
      `;
      
      document.getElementById("repStatsBody").innerHTML = users.map(u => {
        const theirLeads = leads.filter(l => l.assigned_to === u.id);
        const theirSales = theirLeads.filter(l => l.stage && l.stage.includes('Sold')).length;
        return `<tr><td>${u.name}</td><td>${theirLeads.length}</td><td>${theirSales}</td></tr>`;
      }).join('');
    }

    function logout() { localStorage.removeItem("impacta_user"); window.location.href = 'lite9876932.html'; }

    fetchData();
  </script>
</body>
</html>