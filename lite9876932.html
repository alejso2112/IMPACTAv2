<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IMPACTA CRM | Cloud Login</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{ --brand:#0c62ab; --brand-dark:#094a80; --bg:#f1f5f9; --ink:#0f172a; --white:#ffffff; --radius:12px; --line:#e2e8f0; --sans: system-ui, -apple-system, sans-serif; }
    body { margin:0; font-family:var(--sans); background:var(--bg); color:var(--ink); display:flex; align-items:center; justify-content:center; height:100vh; }
    .card { background:var(--white); padding:40px; border-radius:var(--radius); box-shadow:0 20px 40px -10px rgba(0,0,0,0.1); width:100%; max-width:400px; text-align:center; border:1px solid var(--line); }
    .logo { height:50px; margin-bottom:20px; }
    h1 { font-size:24px; margin:0 0 8px; color:var(--brand); }
    p { color:#64748b; font-size:14px; margin:0 0 24px; }
    input { width:100%; padding:12px; margin-bottom:16px; border:1px solid var(--line); border-radius:8px; font-size:14px; box-sizing:border-box; }
    button { width:100%; padding:12px; background:var(--brand); color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer; font-size:14px; transition:0.2s; }
    button:hover { background:var(--brand-dark); }
    .error { color:#b91c1c; font-size:13px; margin-bottom:16px; display:none; background:#fef2f2; padding:10px; border-radius:6px; border:1px solid #fca5a5; }
  </style>
</head>
<body>
  <div class="card">
    <img src="img/logo-main-2026.png" alt="IMPACTA" class="logo">
    <h1>Revenue Engine</h1>
    <p>Cloud Access // Secure Login</p>
    <div id="errorMsg" class="error"></div>
    
    <form id="loginForm" onsubmit="handleLogin(event)">
      <input type="email" id="email" placeholder="Email Address" required />
      <input type="password" id="password" placeholder="Password" required />
      
      <button type="submit" id="submitBtn">Access Dashboard</button>
    </form>
  </div>

  <script>
    // --- CONFIGURATION ---
    const SUPABASE_URL = 'https://imszwgxngjuanjvxigel.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imltc3p3Z3huZ2p1YW5qdnhpZ2VsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5OTI5NDUsImV4cCI6MjA4NTU2ODk0NX0.hag2-X1LVKmQe11QfBt9IYxQC7A9_uranVKgRBJaH4Q';
    
    // Initialize Client
    let supabase;
    try {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    } catch(err) {
        console.warn("Supabase failed to init", err);
    }

    async function handleLogin(event) {
      event.preventDefault(); // STOP RELOAD
      
      const btn = document.getElementById("submitBtn");
      const err = document.getElementById("errorMsg");
      const email = document.getElementById("email").value.trim();
      const pass = document.getElementById("password").value.trim();

      btn.textContent = "Verifying...";
      btn.disabled = true;
      err.style.display = "none";

      // --- THE SKELETON KEY (Admin Override) ---
      if (email === "admin@impacta.com" && pass === "admin") {
          console.log("Admin Override Activated");
          const adminUser = {
              id: "master_admin_override",
              email: "admin@impacta.com",
              role: "manager",
              name: "Admin User (Master)"
          };
          localStorage.setItem("impacta_user", JSON.stringify(adminUser));
          window.location.href = "admin.html";
          return; // Stop here, we are in.
      }

      // --- STANDARD LOGIN (For Reps) ---
      try {
        const { data, error } = await supabase
            .from('users')
            .select('*')
            .eq('email', email)
            .eq('password', pass)
            .single();

        if (error || !data) {
            throw new Error("Invalid credentials.");
        }

        // Success
        localStorage.setItem("impacta_user", JSON.stringify(data));
        
        if(data.role === "manager") {
            window.location.href = "admin.html";
        } else {
            window.location.href = "rep.html";
        }

      } catch (error) {
        console.error("Login Error:", error);
        err.style.display = "block";
        err.textContent = "Access Denied: " + (error.message || "Unknown error");
        btn.textContent = "Access Dashboard";
        btn.disabled = false;
      }
    }
  </script>
</body>
</html>
