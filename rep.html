<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IMPACTA | Sales Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{ --brand:#0c62ab; --brand-dark:#094a80; --ink:#0f172a; --muted:#64748b; --line:#e2e8f0; --bg:#f1f5f9; --radius:12px; --mono: ui-monospace, monospace; --sans: system-ui, -apple-system, sans-serif; }
    *{box-sizing:border-box} body{ margin:0; font-family:var(--sans); background:var(--bg); color:var(--ink); font-size:14px; }
    .topbar{ position:sticky; top:0; z-index:50; border-bottom:1px solid var(--line); background:rgba(255,255,255,.98); backdrop-filter:blur(10px); }
    .topbar .inner{ display:flex; align-items:center; justify-content:space-between; gap:16px; padding:14px 20px; max-width:1800px; margin:0 auto; }
    .brand{display:flex; align-items:center; gap:12px;} .logo{height:40px;width:auto;}
    .btn{ padding:8px 16px; border-radius:8px; background:var(--brand); color:#white; font-weight:600; cursor:pointer; color:#fff; border:none; }
    .btn.secondary{ background:#fff; color:var(--ink); border:1px solid var(--line); }
    .btn.danger{ background:#fff; color:#b91c1c; border:1px solid rgba(185,28,28,.2); }
    .btn.success{ background:#10b981; color:#fff; }
    .wrap{max-width:1800px; margin:0 auto; padding:24px;}
    .card{ background:var(--brand); color:#fff; border-radius:var(--radius); overflow:hidden; }
    .card .hd{ padding:16px 20px; background:rgba(0,0,0,0.15); display:flex; justify-content:space-between; align-items:center; }
    .card .bd{ padding:20px; }
    .tablewrap{ background:#fff; color:var(--ink); border-radius:10px; overflow-x:auto; margin-top:20px; }
    table{ width:100%; border-collapse:collapse; } th, td{ padding:12px; border-bottom:1px solid var(--line); text-align:left; }
    th{ background:#f8fafc; color:var(--muted); font-size:11px; text-transform:uppercase; font-weight:700; position:sticky; top:0; }
    .pill{ padding:4px 8px; border-radius:6px; font-size:11px; font-weight:700; text-transform:uppercase; text-align:center; }
    .pill.stage{ background:#e0f2fe; color:#0369a1; }
    .modal{ position:fixed; inset:0; background:rgba(15,23,42,.7); display:none; align-items:center; justify-content:center; z-index:100; }
    .modal.open{ display:flex; }
    .modal .panel{ width:min(1200px, 95%); height:90vh; background:#f8fafc; border-radius:16px; display:flex; flex-direction:column; overflow:hidden; color:var(--ink); }
    .modal .hd{ background:#fff; padding:16px 24px; border-bottom:1px solid var(--line); display:flex; justify-content:space-between; }
    .bd-grid{ display:grid; grid-template-columns:1fr 1fr; flex:1; overflow:hidden; }
    .modal-col{ padding:24px; overflow-y:auto; } .modal-col.left{ border-right:1px solid var(--line); }
    .modal-grid{ display:grid; gap:16px; grid-template-columns:1fr 1fr; } 
    input, select, textarea{ width:100%; padding:10px; border:1px solid var(--line); border-radius:8px; }
    .timer{ font-family:var(--mono); font-size:24px; font-weight:700; color:var(--brand); }
    .timer.active{ color:#b91c1c; animation:pulse 1s infinite; } @keyframes pulse{0%{opacity:1}50%{opacity:0.6}100%{opacity:1}}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="inner">
      <div class="brand">
        <img src="img/logo-main-2026.png" class="logo" alt="IMPACTA" />
        <div><h1 style="margin:0;font-size:16px;font-weight:700;">IMPACTA Sales</h1></div>
      </div>
      <div class="toolbar">
        <button class="btn" id="btnCreateNew">Create New Lead</button>
      </div>
    </div>
  </div>

  <main class="wrap">
    <section class="card">
      <div class="hd"><h2>My Pipeline</h2><span id="viewStatus" style="font-family:var(--mono);font-size:13px;opacity:0.8"></span></div>
      <div class="bd">
        <div class="tablewrap">
          <table id="leadTable">
            <thead><tr><th>Lead / Company</th><th>Phone</th><th>City</th><th>Stage</th><th>Rec</th><th>Next Action</th><th>Next Due</th><th style="text-align:right">Action</th></tr></thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <div class="modal" id="modal">
    <div class="panel">
      <div class="hd">
        <h3 id="modalTitle" style="margin:0;color:var(--brand);">Lead Details</h3>
        <button class="btn secondary" id="btnCloseModal">Close</button>
      </div>
      <div class="bd-grid">
        <div class="modal-col left">
          <h4 style="margin-top:0;color:var(--muted);">Contact Info</h4>
          <div class="modal-grid">
            <input id="m_firstName" placeholder="First Name"><input id="m_lastName" placeholder="Last Name">
            <input id="m_company" placeholder="Company"><input id="m_phone" placeholder="Phone">
          </div>
          <h4 style="color:var(--muted);margin-top:20px;">Diagnostic</h4>
          <div class="modal-grid">
            <input id="m_gbp1" placeholder="GBP 1"><input id="m_gbp2" placeholder="GBP 2">
            <input id="m_recommendation" placeholder="Recommendation">
          </div>
          <h4 style="color:var(--muted);margin-top:20px;">Internal</h4>
          <select id="m_stage">
             <option value="New Lead">New Lead</option><option value="Attempting">Attempting</option>
             <option value="Connected">Connected</option><option value="Booked">Booked</option>
             <option value="Sold">Sold</option><option value="Nurture">Nurture</option>
          </select>
        </div>
        <div class="modal-col right">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;background:#fff;padding:15px;border:1px solid var(--line);border-radius:12px;">
            <div id="callTimer" class="timer">00:00</div>
            <div>
               <button class="btn success" id="btnCallStart">ðŸ“ž Call</button>
               <button class="btn danger" id="btnCallEnd" style="display:none;">End</button>
            </div>
          </div>
          <textarea id="logNote" placeholder="Log notes here..." style="height:100px;margin-bottom:10px;"></textarea>
          <div class="modal-grid">
             <select id="m_nextAction"><option>Call Attempt</option><option>Follow-up</option></select>
             <input type="datetime-local" id="m_nextDue">
          </div>
          <button class="btn" id="btnSaveLog" style="width:100%;margin-top:20px;">Save & Next</button>
          
          <div style="margin-top:20px;border-top:1px solid var(--line);">
             <table style="margin-top:0;">
                <tbody id="logTbody"></tbody>
             </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- CONFIGURATION ---
    const SUPABASE_URL = 'https://imszwgxngjuanjvxigel.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imltc3p3Z3huZ2p1YW5qdnhpZ2VsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5OTI5NDUsImV4cCI6MjA4NTU2ODk0NX0.hag2-X1LVKmQe11QfBt9IYxQC7A9_uranVKgRBJaH4Q';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- APP LOGIC ---
    let leads = [];
    let activeLeadId = null;
    let timerInterval = null;
    const currentUser = JSON.parse(localStorage.getItem("impacta_user"));

    if(!currentUser) window.location.href = "lite9876932.html";

    // Setup Logout
    const tb = document.querySelector(".toolbar");
    const btnLogout = document.createElement("button");
    btnLogout.className = "btn secondary";
    btnLogout.textContent = "Logout";
    btnLogout.style.marginLeft = "10px";
    btnLogout.onclick = () => { localStorage.removeItem("impacta_user"); window.location.href="lite9876932.html"; };
    tb.appendChild(btnLogout);

    async function fetchLeads() {
      let query = supabase.from('leads').select('*').order('next_due', { ascending: true, nullsFirst: false });
      
      // Security Filter: Only show my leads
      if(currentUser.role !== 'manager') {
        query = query.eq('assigned_to', currentUser.id);
      }
      
      const { data, error } = await query;
      if(!error) {
        leads = data || [];
        render();
      }
    }

    function render() {
      document.getElementById("tbody").innerHTML = leads.map(l => `
        <tr>
          <td><b>${l.company || 'Unknown'}</b><br><span style="font-size:12px;color:#64748b">${l.first_name||''} ${l.last_name||''}</span></td>
          <td><a href="tel:${l.phone}">${l.phone||''}</a></td>
          <td>${l.city||''}</td>
          <td><span class="pill stage">${l.stage}</span></td>
          <td>${l.recommendation||''}</td>
          <td>${l.next_action||''}</td>
          <td>${l.next_due ? new Date(l.next_due).toLocaleDateString() : ''}</td>
          <td style="text-align:right"><button class="btn" style="padding:4px 10px;font-size:12px;" onclick="openLead('${l.id}')">Work</button></td>
        </tr>
      `).join('');
      document.getElementById("viewStatus").textContent = `${leads.length} Active Leads`;
    }

    window.openLead = function(id) {
      activeLeadId = id;
      const l = leads.find(x => x.id === id);
      if(!l) return;
      
      // Map inputs
      ['firstName','lastName','company','phone','stage'].forEach(k => {
         const el = document.getElementById("m_"+k);
         // Supabase uses snake_case, map to camelCase logic or manual
         const val = l[k.replace(/[A-Z]/g, letter => `_${letter.toLowerCase()}`)] || l[k] || ""; 
         if(el) el.value = val;
      });
      // Manual mapping for odd fields if needed
      document.getElementById("m_firstName").value = l.first_name || "";
      document.getElementById("m_lastName").value = l.last_name || "";
      document.getElementById("m_gbp1").value = l.gbp1 || "";
      document.getElementById("m_gbp2").value = l.gbp2 || "";
      document.getElementById("m_recommendation").value = l.recommendation || "";

      // Logs
      const logs = l.activity || [];
      document.getElementById("logTbody").innerHTML = logs.map(log => `
        <tr><td style="font-size:12px;color:#64748b">${new Date(log.ts).toLocaleString()}</td><td style="font-size:13px"><b>${log.action}</b>: ${log.text}</td></tr>
      `).join('');

      document.getElementById("modal").classList.add("open");
    }

    document.getElementById("btnCloseModal").onclick = () => {
       document.getElementById("modal").classList.remove("open");
       clearInterval(timerInterval);
       document.getElementById("callTimer").textContent = "00:00";
       document.getElementById("btnCallStart").style.display="inline-flex";
       document.getElementById("btnCallEnd").style.display="none";
    };

    // Timer Logic
    document.getElementById("btnCallStart").onclick = () => {
       const ph = document.getElementById("m_phone").value;
       if(ph) window.location.href = `tel:${ph}`;
       
       let s = 0;
       document.getElementById("callTimer").classList.add("active");
       document.getElementById("btnCallStart").style.display="none";
       document.getElementById("btnCallEnd").style.display="inline-flex";
       
       timerInterval = setInterval(() => {
         s++;
         const m = Math.floor(s/60).toString().padStart(2,'0');
         const sec = (s%60).toString().padStart(2,'0');
         document.getElementById("callTimer").textContent = `${m}:${sec}`;
       }, 1000);
    };

    document.getElementById("btnCallEnd").onclick = () => {
       clearInterval(timerInterval);
       document.getElementById("callTimer").classList.remove("active");
       const dur = document.getElementById("callTimer").textContent;
       document.getElementById("logNote").value = `[Call ${dur}] ` + document.getElementById("logNote").value;
       document.getElementById("btnCallStart").style.display="inline-flex";
       document.getElementById("btnCallEnd").style.display="none";
    };

    document.getElementById("btnSaveLog").onclick = async () => {
      if(!activeLeadId) return;
      const note = document.getElementById("logNote").value;
      const nextAct = document.getElementById("m_nextAction").value;
      
      const newLog = { ts: new Date().toISOString(), action: "Log", text: note, by: currentUser.name };
      const l = leads.find(x => x.id === activeLeadId);
      const updatedActivity = [newLog, ...(l.activity || [])];

      const { error } = await supabase.from('leads').update({
        activity: updatedActivity,
        stage: document.getElementById("m_stage").value,
        next_action: nextAct,
        updated_at: new Date().toISOString()
      }).eq('id', activeLeadId);

      if(!error) {
        document.getElementById("modal").classList.remove("open");
        document.getElementById("logNote").value = "";
        fetchLeads();
      }
    };
    
    // Create New Lead (Rep side)
    document.getElementById("btnCreateNew").onclick = () => {
        // Simple create logic: Create empty lead assigned to self, then open it
        // For brevity in this fix, we will just alert. 
        // In full prod, this would open a 'Create' modal.
        const comp = prompt("Enter Company Name:");
        if(comp) {
            supabase.from('leads').insert([{
                company: comp,
                stage: 'New Lead',
                assigned_to: currentUser.id,
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            }]).then(() => fetchLeads());
        }
    };

    fetchLeads();
  </script>
</body>
</html>
